<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.0.1"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false,"dimmer":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本来题目是想写实践篇的，但是折腾一圈下来发现这应该叫折腾篇才对，因为实在是太太太。。。折腾了">
<meta name="keywords" content="NAS,OpenMediaVault,黑群晖">
<meta property="og:type" content="article">
<meta property="og:title" content="NAS打造日志--折腾篇">
<meta property="og:url" content="https://kiritox.me/archives/nas-build-log-practical.html">
<meta property="og:site_name" content="KiritoA&#39;s Blog">
<meta property="og:description" content="本来题目是想写实践篇的，但是折腾一圈下来发现这应该叫折腾篇才对，因为实在是太太太。。。折腾了">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1099110739.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3779195123.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1506247690.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2782324303.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3673292591.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3053182115.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3802864263.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3390727222.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2388227607.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1644503815.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1391370919.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2139503587.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3848539345.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/3457044370.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/11/752782792.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/11/2050578598.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2802675353.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/11/3091046160.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1124842396.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/4261694920.jpg">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2391837075.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1024739463.png">
<meta property="og:image" content="https://kiritoa.github.io/usr/uploads/2016/07/2335383978.png">
<meta property="og:updated_time" content="2019-03-31T10:16:18.786Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NAS打造日志--折腾篇">
<meta name="twitter:description" content="本来题目是想写实践篇的，但是折腾一圈下来发现这应该叫折腾篇才对，因为实在是太太太。。。折腾了">
<meta name="twitter:image" content="https://kiritoa.github.io/usr/uploads/2016/07/1099110739.png">



  <link rel="alternate" href="/atom.xml" title="KiritoA's Blog" type="application/atom+xml"/>




  <link rel="canonical" href="https://kiritox.me/archives/nas-build-log-practical.html"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>NAS打造日志--折腾篇 | KiritoA's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">KiritoA's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br/>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br/>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br/>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives menu-item-active">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br/>Archives</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://kiritox.me/archives/nas-build-log-practical.html"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="KiritoA"/>
      <meta itemprop="description" content="一个高端大气上档次的网站（雾"/>
      <meta itemprop="image" content="/images/avatar.png"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="KiritoA's Blog"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">NAS打造日志--折腾篇

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-07-17 19:09:00" itemprop="dateCreated datePublished" datetime="2016-07-17T19:09:00+08:00">2016-07-17</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/NAS/" itemprop="url" rel="index"><span itemprop="name">NAS</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/archives/nas-build-log-practical.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="archives/nas-build-log-practical.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本来题目是想写实践篇的，但是折腾一圈下来发现这应该叫折腾篇才对，因为实在是太太太。。。折腾了</p>
<a id="more"></a>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>个人的要求比较简单，不需要很多人追捧的HTPC+NAS二合一，也不需要搞个什么E3 CPU，NAS就应当好好地当好它的本职工作，具体需求就是:</p>
<ul>
<li>File Server：基本的文件存取服务器，NAS核心功能，包括局域网访问和远程访问（云端服务器）</li>
<li>DLNA Server：让设备端轻松看各种下载视频和音频</li>
<li>远程下载：远程控制下载，回到家就能看视频</li>
<li>硬盘盘位：4-6个</li>
<li>性能与功耗：要求必须低功耗（电费），性能不需要太高</li>
<li>体积：ITX或M-ATX均可，优先ITX</li>
</ul>
<p>潜在需求：</p>
<ul>
<li>软路由提供透明代理网络环境</li>
</ul>
<h2 id="硬件选型"><a href="#硬件选型" class="headerlink" title="硬件选型"></a>硬件选型</h2><p>实际开始打造之前对硬件方案进行了<a href="https://kiritox.me/archives/nas-build-hardware-solution.html">一些研究</a>，因为手头上有一些之前DIY剩下的零部件，包括机箱，电源，内存等等，因此本次实际打造只买了一块主板，总花费470元。</p>
<p>硬件配置：</p>
<ul>
<li>主板+CPU：ASROCK J3160M – 470元</li>
<li>内存：2 x 威刚DDR3 1600 4G</li>
<li>机箱：酷冷至尊毁灭者经典U3升级版</li>
<li>电源：酷冷至尊战斧二代400W电源</li>
<li>硬盘：1x希捷1TB + 1x希捷250GB</li>
</ul>
<p>曾被AMD坑过的我现在买新CPU都是首选Intel，因此根据Intel最新发布的<a href="http://www.intel.com/content/www/us/en/processors/public-roadmap-article.html" title="Roadmap" target="_blank" rel="noopener">Roadmap</a>选择了 <a href="http://ark.intel.com/products/91533/Intel-Celeron-Processor-J3160-2M-Cache-up-to-2_24-GHz" target="_blank" rel="noopener">Intel Celeron J3160</a>，J3160是Intel 16’Q1新发布的一款超低功耗SoC CPU，TDP仅为6W，支持VT-x、AES等，性能一般但已经可以满足基本NAS需求，做软路由也相当不错。考虑到要低功耗的原因没有选G1840, G4400这些型号，虽然总有人说功耗也高不了多少不要迷恋低功耗之类的，但是这两个CPU idle功率要高10W左右，有负载时就更高了。而J3160有负载时功耗也仅在15W-20W之间。更何况品牌NAS也都是有用J3160，J1900，N3150这些低功耗U。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1099110739.png" alt="Screenshot 2016-07-13 20.46.55.png"></p>
<p>个人认为CPU选择要根据实际出发不要盲目跟风，如果没有虚拟化、HTPC、实时转码、编码、渲染。。。之类的需求高性能的CPU也是浪费。</p>
<p>主板方面选择的是华擎的<a href="http://www.asrock.com/mb/Intel/J3160M/index.asp" target="_blank" rel="noopener">J3160M</a>，M-ATX规格主板，2xSATA3接口，CPU被动散热无需风扇。选择它主要是因为手头上有多余的台式DDR3内存可以用上，而且也有不错的扩展性（3xPCI-E Slot），不过SATA接口略不足，需要加SATA扩展卡扩展。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3779195123.jpg" alt="J3160M(L2).jpg"></p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1506247690.jpg" alt="J3160M(L5).jpg"></p>
<p>而ITX版本<a href="http://www.asrock.com/mb/Intel/J3160-ITX/index.asp" target="_blank" rel="noopener">华擎J3160-ITX</a>提供4xSATA3，1xPCI-E Slot + 1x Mini-PCIE Slot，使用笔记本DDR3/DDR3L内存，如果对体积有需求直接考虑ITX板。如果想拓展SATA口可以买Mini-PCIE插槽的扩展卡，可额外提供2个SATA接口。</p>
<p>内存8G的确是有点过剩了，如果不上虚拟化的话迟些出掉一条或者装到另一台电脑上。</p>
<p>硬盘都是之前留下来的东西，虽然说希捷坏盘率高什么的，但两块硬盘用了这么多年都还健在，也没看到警告信息，可能是运行时间不长的原因吧(◔౪◔)（两硬盘在线时间均为3000小时左右）。不过迟些会上WD的红盘。</p>
<p>实际测试了一下功耗，总结如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">测试条件</th>
<th style="text-align:center">功率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">无硬盘运行（运行PE系统测试）</td>
<td style="text-align:center">15W</td>
</tr>
<tr>
<td style="text-align:center">1T 单硬盘运行</td>
<td style="text-align:center">25W</td>
</tr>
<tr>
<td style="text-align:center">1T 单硬盘休眠</td>
<td style="text-align:center">20W</td>
</tr>
<tr>
<td style="text-align:center">1T+250G 双硬盘硬盘运行</td>
<td style="text-align:center">35W</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="软件方案"><a href="#软件方案" class="headerlink" title="软件方案"></a>软件方案</h2><p>比较知名的免费NAS系统有：FreeNAS、NAS4Free、OpenMediaVault（详细介绍可以<a href="http://blog.brianmoses.net/2015/04/diy-nas-software-roundup.html" target="_blank" rel="noopener">看这里</a>）其他系统方案还有黑群晖和Windows Server。</p>
<blockquote>
<p>FreeNAS、OpenMediaVault、NAS4Free关系：Olivier Cochard-Labbe在2005年创建了FreeNAS项目，后Volker Theile加入该项目作为核心开发人员；2009年12月Olivier Cochard-Labbe发表声明停止为FreeNAS 0.7版本开发新功能后，Volker Theile创建了基于Debian Linux的OpenMediaVault项目，并采用GPLv3授权；iXsystems收购FreeNAS后重写了网页框架和构架在2011年发布了全新的FreeNAS 8版本；2011年其余开发者基于FreeNAS 0.7开发了分支并重新命名为NAS4Free。<br><em>引用:<a href="http://songming.me/openmediavault-setup.html" target="_blank" rel="noopener">http://songming.me/openmediavault-setup.html</a></em></p>
</blockquote>
<h3 id="FreeNAS、NAS4Free"><a href="#FreeNAS、NAS4Free" class="headerlink" title="FreeNAS、NAS4Free"></a>FreeNAS、NAS4Free</h3><p>这两个系统是基于FreeBSD开发，使用ZFS分区，对内存需求比较高，官方强烈推荐使用ECC内存，而且至少需要8GB，虽然这两个系统相当不错，但本次计划没有ECC内存因此只能排除这两个方案。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/2782324303.png" alt="910gui.png"></p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3673292591.png" alt="NewNas4freescreenshot.png"></p>
<h3 id="OpenMediaVault"><a href="#OpenMediaVault" class="headerlink" title="OpenMediaVault"></a>OpenMediaVault</h3><p>OpenMediaVault是基于Debian的NAS系统，简称OMV。由于是一个Linux-based的系统，可以支持Ext3, Ext4, XFS, JFS等Linux常见分区，除了OMV本身提供的插件也可以自行安装各种基于Linux应用，总的来说是十分强大的，近几年来也渐渐火起来。</p>
<h3 id="黑群晖"><a href="#黑群晖" class="headerlink" title="黑群晖"></a>黑群晖</h3><p>黑群晖是通过破解品牌NAS<strong>群晖</strong>的系统启动引导，制作出引导文件使普通电脑都可以安装群晖系统，实际使用上基本达到与群晖一致的体验，想说一下的是有人声称群晖使用的是加密分区格式，系统一旦损坏数据就拿不出来。实际上群晖使用就是Linux的EXT4分区，不存在加密一说，使用Linux-based系统就可以把里面的内容提取出来，官方也提供了相关教程。不过黑群晖肯定是非官方授权的也是没有售后支援的，所以使用上会有一定的风险，出现问题要自己解决。</p>
<h3 id="Windows-Server-2012-R2-Windows-10"><a href="#Windows-Server-2012-R2-Windows-10" class="headerlink" title="Windows Server 2012 R2 / Windows 10"></a>Windows Server 2012 R2 / Windows 10</h3><p>Windows Server系统的话就不用多说了，功能强大而且配置flexible，有需要可以上Hyper-V虚拟化，不过500刀的价钱不是每个人都能承受的起。Windows 10同样支持虚拟化，对于不想折腾的人来说也是个不错的选择。<em>（请支持正版）</em></p>
<hr>
<h2 id="折腾篇"><a href="#折腾篇" class="headerlink" title="折腾篇"></a>折腾篇</h2><h3 id="OpenMediaVault初体验"><a href="#OpenMediaVault初体验" class="headerlink" title="OpenMediaVault初体验"></a>OpenMediaVault初体验</h3><p>OMV总的来说也算是一个不错的系统，对于熟悉Linux的人来说实在是太方便，但是官方给出了这么一个需求：</p>
<blockquote>
<p><strong>System Drive</strong><br>The whole disc will be occupied by the System and swap space, so size doesn’t matter so much. Data storage on the system disc is not supported.<br>Spinning Harddisk, SSD, Disk-on-Module, CompactFlash or USB thumb drive type drives can be used as System Drive.<br><strong>If you use a Flash Drive, select one with static wear leveling, without it the drive will have a very short lifetime.</strong> It is also recommended to activate the Flash memory Plugin: (see Plug-ins) The entire disk is used as system disk. This disk can not be used to store user data.<br><em><a href="http://wiki.openmediavault.org/index.php?title=Prerequisites" target="_blank" rel="noopener">http://wiki.openmediavault.org/index.php?title=Prerequisites</a></em></p>
</blockquote>
<p>大致的意思就是，如果你使用Flash储存设备做系统盘的话，要找那些静态损耗均衡（就是类似SSD Trim技术的意思）的设备，不然的话很快就会完蛋，所以一定要找长擦写寿命的。使用SSD是个比较好的选择，系统安装好后虽然会把整个硬盘占用了，但是可以自行分区腾出空间供作储存。但是手头上没有SSD硬盘空闲，电商逛了一圈现在一线大厂SSD 60G价格跟128/120G的都差不多价格，便宜的SSD又怕出问题。偶然看到有SLC U盘这么一样东西，据说寿命比普通U盘都要长，于是在淘宝找了个59包邮的SLC U盘，本来想着系统盘读写量又不是很大找个便宜点的U盘就算了（据说都是小作坊产品），而且这个是SLC储存理论上寿命也是可以的(Flag)。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3053182115.jpg" alt="T1YWYhXj8eXXc3ZFI2_043031.jpg_430x430q90.jpg"></p>
<p>安装完成后看到界面，看起来还是不错的，有一些插件需要安装第三方安装包，根据个人需求，安装DLNA插件和VirtualBox就差不多了。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3802864263.png" alt="Screenshot 2016-07-10 16.31.00.png"></p>
<p>然而当我重启到Ubuntu Live，打开GParted分区工具打算对1T硬盘重新分下区的时候，有个警告说U盘的分区信息读不出来，当时不怎么在意，分完区重启后。。。<br>无法引导？？？</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3390727222.jpg" alt="u=2803535311,2760847748&amp;fm=21&amp;gp=0.jpg"></p>
<p>Round1：好吧。。可能是分区的时候损坏了（玄学？），只好重新分区重装OMV，配置好各种服务，Perfect！关机睡觉。<br>第二天再开机，突然弹了个提示说GRUB引导损坏什么的，强行重启，结果直接黑屏只有左上角一个无限闪烁的光标。。。<br>。。。<br>。。。<br>。。。<br><img src="https://kiritoa.github.io/usr/uploads/2016/07/2388227607.jpg" alt="u=2270715368,1387150590&amp;fm=21&amp;gp=0.jpg"></p>
<p>Round2：嗯？噢上次弄虚拟机的时候好像动过内核，好吧这次不加那么多插件了，就开默认服务运行，应该可以了吧。<br>然后过了几天。。<br>嗯？黑屏？</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1644503815.jpg" alt="u=905893674,3377138487&amp;fm=21&amp;gp=0.jpg"></p>
<p>很好，这次U盘插到手提上直接识别不了了，U盘指示灯持续闪烁，似乎被玩坏了。。我去这还不是U盘问题？然后。。。然后火速退货了。。。</p>
<p>特么真的是便宜没好货啊。。折腾了一个星期结果又回到原点，NAS依然无法上线。无奈下还是要继续考虑其他方案。</p>
<p>Round3：找找手头上有个2G老U盘空闲可以当系统盘，那就安装上去试试吧，然而使用起来发现2M/s写入的速度实在太感人了，安装个插件都要10分钟，遂放弃。</p>
<p>Round4：拿个4G Micro SD卡来试试，用那2G U盘坐安装盘，但U盘似乎不兼容Debian，安装程序找不到CR-ROM安装文件，中间重试了若干次。。。<br>好吧。。只好在虚拟机安装，这下终于好了，然而当我要安装插件的时候。。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1391370919.png" alt="Screenshot 2016-07-09 22.11.03.png"></p>
<p>然后就卡！死！了！</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/2139503587.jpg" alt="u=3327417102,2711826164&amp;fm=21&amp;gp=0.jpg"></p>
<p>心好累。。至此宣布放弃，从此不再用U盘安装。。啊不对，劳资不玩OMV了！（手动再见）</p>
<hr>
<p>Round5：手头没SSD始终比较麻烦，能安装到U盘的NAS系统还有FreeNAS、NAS4Free，虽然是有8G内存达到要求，但没有ECC始终是一个风险，因为ZFS文件系统极度依赖内存的可靠性（数据无价）。看看手头上剩下的选择，虽然有些无奈，但只有黑群晖可以选择了。</p>
<h3 id="黑群晖折腾篇"><a href="#黑群晖折腾篇" class="headerlink" title="黑群晖折腾篇"></a>黑群晖折腾篇</h3><p>群晖的系统都会在每一块硬盘安装一份，而不是安装在U盘，U盘只会在开机做引导作用，至少不会那么容易被玩坏。。</p>
<p>Round6：黑群晖安装教程可以参考这个<a href="http://www.nasyun.com/thread-24296-1-1.html" target="_blank" rel="noopener">帖子</a>，不过建议黑群晖版本去官网找个新版本些的，<a href="http://xpenology.me/downloads/" target="_blank" rel="noopener">XPEnology黑群晖官网下载</a>。</p>
<p>按照教程修改引导镜像，写入U盘，第一次引导时要在启动菜单选择Install/Upgrade一项，进行群晖系统的安装。</p>
<p>使用Synology Assistant很快就可以找到NAS的机器</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/3848539345.png" alt="Untitled.png"></p>
<p>写入系统文件<br><img src="https://kiritoa.github.io/usr/uploads/2016/07/3457044370.png" alt="Screenshot 2016-07-10 19.04.52.png"></p>
<p>安装完成，相比起OVM安装步骤(标准Linux安装程序)实在是太轻松了。</p>
<p>界面方面看起来比其他NAS系统都要好看得多，毕竟是商业系统。<br><img src="https://kiritoa.github.io/usr/uploads/2016/11/752782792.jpg" alt="Screenshot 2016-07-10 19.37.40.jpg"></p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/11/2050578598.jpg" alt="Screenshot 2016-07-10 20.21.05.jpg"></p>
<p>安装完毕，接下来按照里面的帮助文档配置好系统就可以正常使用了，难度不会太高。</p>
<p>因为SATA接口的硬盘在群晖系统可以使用前都要先初始化，里面的数据都要被清空，由于1T硬盘已经存有各种资料，只好把群晖系统安装在250G的硬盘上，1T的数据只能等买新硬盘才能导入进去了。不过群晖可以做到插入移动硬盘等外部设备时自动开启共享，这样把硬盘插到USB硬盘座再连接上NAS大概可以临时解决访问问题。</p>
<p>群晖这些商业操作系统的界面相对于OMV这些开源系统都会人性化得多，除了移动硬盘即插即用即共享外还有其他一些亮点，例如在OMV里文件管理器是一个插件，而且显示方式是跟Linux结构是一样的，硬盘分区都藏在很深的目录里。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/2802675353.png" alt="Screenshot 2016-07-13 20.57.22.png"></p>
<p>没有Linux基础的人一眼过去肯定是找不到目录的。。。</p>
<p>群晖就内置了一个文件管理器，目录显示也是简洁明了，操作起来就像用Windows文件管理器一样。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/11/3091046160.jpg" alt="Screenshot 2016-07-10 21.00.45.jpg"></p>
<p>当然优点还有很多很多，有兴趣可以虚拟机安装一个试试或者上官网体验一下。</p>
<p>说了那么多群晖的优点也不是说完全没缺点的，例如因为系统主体是放在硬盘里的，休眠的硬盘经常会被唤醒（白群晖也应该会遇到），例如打开群晖的Web控制台，DLNA浏览目录时都会唤醒硬盘。如果Windows中共享文件夹映射驱动器后更是出现无法休眠的情况，在Web控制台中可以看到Windows访问共享目录的会话。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1124842396.png" alt="Screenshot 2016-07-12 17.48.33.png"></p>
<p>只有手动切断会话才可以使硬盘休眠，这个问题反而比OMV要糟糕了，因为NAS硬盘在映射驱动器后即使在不访问时也会持续运转，只有关机重启才会断开连接，不但功耗高了，长时间运行也会怕影响硬盘寿命。</p>
<h3 id="OpenMediaVault·续"><a href="#OpenMediaVault·续" class="headerlink" title="OpenMediaVault·续"></a>OpenMediaVault·续</h3><p>Round7：没错，我反悔了，我又玩OMV了。先+1s</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/4261694920.jpg" alt="img-4379638a8e3389760a3b855e8b017b4a.jpg"></p>
<p>考虑到硬盘休眠唤醒这个问题不是很理想，于是打算再好好研究一下之前的问题，因为Web界面卡死，这一次选择在SSH里面安装软件包测试，执行apt-get update的时候弹出了这个错误</p>
<pre><code>Err http://mirrors.163.com wheezy Release.gpg 
Something wicked happened resolving &apos;mirrors.163.com:http&apos; (-5 - No address associated with hostname)
Err http://security.debian.org wheezy/updates Release.gpg
Something wicked happened resolving &apos;security.debian.org:http&apos; (-5 - No address associated with hostname)
Err http://packages.openmediavault.org stoneburner Release.gpg
Something wicked happened resolving &apos;packages.openmediavault.org:http&apos; (-5 - No address associated with hostname)
</code></pre><p>无法解析域名。。DNS服务器挂了？但网络是正常的啊，其他电脑也能正常上网。Google了一番，终于检查到是<code>/etc/resolv.conf</code>里面的DNS地址是错误的，因为之前在虚拟机安装OMV的网卡是NAT模式，因此被设置成一个错误的DNS IP地址（虚拟网卡的网关IP，跟实际网络IP不同），立马更改回来，一切正常了，终于是明白了之前界面卡死的原因。</p>
<p>不过在Micro SD卡装的系统，安装程序那感人的速度又让我想起用树莓派的日子了。。。还好使用时不会影响反应速度</p>
<p>然后对比了一下两系统硬盘休眠被唤醒的情况：</p>
<p><em>测试条件：开启SMB/CIFS共享服务和DLNA共享服务，OMV和群晖均开启硬盘休眠功能</em></p>
<table>
<thead>
<tr>
<th>使用场景</th>
<th>OpenMediaVault</th>
<th>群晖</th>
</tr>
</thead>
<tbody>
<tr>
<td>DLNA浏览目录，不点开媒体文件</td>
<td>休眠</td>
<td>唤醒</td>
</tr>
<tr>
<td>映射驱动器</td>
<td>休眠</td>
<td>唤醒</td>
</tr>
<tr>
<td>映射驱动器后，硬盘休眠后后点开”计算机”图标</td>
<td>几秒后自动唤醒</td>
<td>映射驱动器后一直唤醒</td>
</tr>
<tr>
<td>添加网络位置后，硬盘休眠后点开”计算机”图标</td>
<td>休眠</td>
<td>几秒后自动唤醒</td>
</tr>
<tr>
<td>登陆Web管理界面</td>
<td>休眠</td>
<td>唤醒</td>
</tr>
<tr>
<td>登陆Web管理界面，点击硬盘设置相关页面</td>
<td>唤醒</td>
<td>唤醒</td>
</tr>
<tr>
<td>打开Windows资源管理器，Quick access一栏中有NAS的文件记录</td>
<td>唤醒</td>
<td>唤醒</td>
</tr>
</tbody>
</table>
<p>到底谁好谁坏呢？这里并没有得出结论，如果硬盘经常性唤醒，频繁开关可能会影响硬盘寿命。硬盘保持唤醒有即时反应的优势，因为休眠的硬盘启动到响应操作需要一定的时间，但这样整体功耗相对又会比较高。所谓熊掌不可兼得大概也就如此吧。</p>
<p>根据测试情况，建议<strong>尽量不要映射网络驱动器</strong>，这样可以避免出现时常唤醒硬盘的情况，而且使用映射网络驱动器时如果NAS没开机而其他电脑先开机还会有错误框弹出。当然了如果有需求的话除外，说实话这个功能还是挺好用的。</p>
<p>一个比较好的替代方案是使用<strong>添加网络位置</strong>功能（OMV有效），这样在Windows中只会把NAS共享文件夹看成是文件夹，而不是一个驱动器，虽然损失了一些高级功能（把共享文件夹看作一个真实分区），但硬盘再也不会频繁休眠唤醒了。</p>
<p>至此，NAS算是稳定配置好了，到头来还是用回了OMV，毕竟是Linux-based系统，耐得起折腾，使用黑裙晖还有合法性问题。不过自己DIY NAS，路上都是一个又一个坑啊，不想折腾还是买成品吧(´c_`)。</p>
<h3 id="速度实测"><a href="#速度实测" class="headerlink" title="速度实测"></a>速度实测</h3><p>NAS最重要的一点就是要求网络环境达到千兆速度，最好先将网络环境升级到千兆有线网络（包括路由器、网线、网卡）再部署NAS，有线网络环境达标才能有比较好的访问速度。</p>
<p>读取速度：NAS到PC</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/2391837075.png" alt="read.png"></p>
<p>写入速度：PC到NAS</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/1024739463.png" alt="write.png"></p>
<p>总体感觉还是比较满意的，读写都能达到千兆网络的瓶颈速度，CPU占用率上升到40%左右，当然这还要靠强大的希捷1T硬盘，用了这么多年都仍然保持着读写100M/s的水准，因此一直都没考虑过要加固态硬盘。</p>
<p>WIFI环境下就变成了这个可怜的速度。。。</p>
<p><img src="https://kiritoa.github.io/usr/uploads/2016/07/2335383978.png" alt="Screenshot 2016-07-16 13.00.02.png"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>根据之前的需求列表，本次打造的完成情况：</p>
<ul>
<li>File Server √</li>
<li>DLNA Server √</li>
<li>远程下载 ×</li>
<li>软路由透明代理 ×</li>
</ul>
<p>远程下载Linux下的解决方案有迅雷Linux版<strong>xware</strong>，在OMV安装配置略麻烦，而且开启迅雷后所有硬盘无法休眠。由于目前没有24小时下载的需求，以后有需要再进一步研究。</p>
<p>软路由本来是打算在Virtualbox安装Openwrt，用一只无线网卡做AP。但配置起来比有线网卡要麻烦得多，初始化配置需要有线网卡，只好待有线网卡部署到位再进行配置。</p>
<h2 id="附录：NAS系统组合方案"><a href="#附录：NAS系统组合方案" class="headerlink" title="附录：NAS系统组合方案"></a>附录：NAS系统组合方案</h2><p>关于NAS安装系统的方案，知乎上有一个问题“<a href="https://www.zhihu.com/question/21359049" target="_blank" rel="noopener">自己家里搭建NAS服务器有什么好方案</a>”推荐看一看，其中答主<strong>MarKAde</strong>的总结比较好，简单归纳为以下几种：</p>
<ol>
<li>NAS单系统</li>
<li>Windows+DSM双系统，DSM作为主要存储、共享系统</li>
<li>FreeNAS系统，通过Jail插件跑Windows虚拟机</li>
<li>Windows+黑群晖双系统，Windows为主，黑群晖作为补充（答主推荐）</li>
<li>Windows单系统</li>
<li>Linux单系统</li>
<li>ESXi或Hyper-V Server</li>
</ol>
<p>个人建议有ECC内存就直接上FreeNAS。在Windows中虚拟化使用黑群晖的话可以在Hyper-V中直通硬盘，这样即使不想用Windows系统时直接裸跑黑群晖的话只要找一只U盘做启动盘就可以做到无缝切换了。</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/NAS/" rel="tag"># NAS</a>
          
            <a href="/tags/OpenMediaVault/" rel="tag"># OpenMediaVault</a>
          
            <a href="/tags/黑群晖/" rel="tag"># 黑群晖</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/archives/nas-build-hardware-solution.html" rel="next" title="NAS 打造日志-硬件方案篇">
                <i class="fa fa-chevron-left"></i> NAS 打造日志-硬件方案篇
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/archives/home-fiber-network-upgrade-log.html" rel="prev" title="电信光纤升级笔记">
                电信光纤升级笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="KiritoA"/>
            
              <p class="site-author-name" itemprop="name">KiritoA</p>
              <p class="site-description motion-element" itemprop="description">一个高端大气上档次的网站（雾</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/KiritoA" title="GitHub &rarr; https://github.com/KiritoA" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://twitter.com/KiritoA_TH" title="Twitter &rarr; https://twitter.com/KiritoA_TH" rel="noopener" target="_blank"><i class="fa fa-fw fa-twitter"></i>Twitter</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://yian.me/blog/" title="https://yian.me/blog/" rel="noopener" target="_blank">Y!an's Blog</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://deepindream.github.io/" title="https://deepindream.github.io/" rel="noopener" target="_blank">DeepinDream's Blog</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#需求分析"><span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#硬件选型"><span class="nav-text">硬件选型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#软件方案"><span class="nav-text">软件方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#FreeNAS、NAS4Free"><span class="nav-text">FreeNAS、NAS4Free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenMediaVault"><span class="nav-text">OpenMediaVault</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黑群晖"><span class="nav-text">黑群晖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-Server-2012-R2-Windows-10"><span class="nav-text">Windows Server 2012 R2 / Windows 10</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#折腾篇"><span class="nav-text">折腾篇</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenMediaVault初体验"><span class="nav-text">OpenMediaVault初体验</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#黑群晖折腾篇"><span class="nav-text">黑群晖折腾篇</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenMediaVault·续"><span class="nav-text">OpenMediaVault·续</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#速度实测"><span class="nav-text">速度实测</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-text">后记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录：NAS系统组合方案"><span class="nav-text">附录：NAS系统组合方案</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">KiritoA</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.1"></script>


  
  
  
  <script id="dsq-count-scr" src="https://kiritox-blog.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "https://kiritox.me/archives/nas-build-log-practical.html";
    this.page.identifier = "archives/nas-build-log-practical.html";
    this.page.title = 'NAS打造日志--折腾篇';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://kiritox-blog.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    loadComments();
  
</script>





  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
